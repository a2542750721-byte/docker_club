# Pyodide & Monaco Integration Guide

## 1. Architecture Overview

The IDE module (`ide.php` + `scripts.js`) uses a hybrid loading architecture to support both online (CDN) and offline (Local) environments.

### Components
1.  **Backend (`toolbox.php`)**: Detects the environment.
    *   Checks for the existence of `assets/js/lib/pyodide/pyodide.js`.
    *   Injects a global configuration object `window.IDE_CONFIG` into the page.
2.  **Frontend (`scripts.js`)**: Implements the `IdeManager` class.
    *   Reads `window.IDE_CONFIG`.
    *   Loads Monaco Editor via `require.js`.
    *   Loads Pyodide WebAssembly engine.
    *   Manages execution state and error handling.

## 2. Configuration

The configuration is automatically generated by PHP, but follows this structure:

```javascript
window.IDE_CONFIG = {
    paths: {
        // Path to Monaco Editor VS directory (CDN or Local)
        monacoBase: "...", 
        // Path to Pyodide directory (Empty string for CDN, or local path)
        pyodideIndex: "..."
    },
    flags: {
        isPyodideLocal: true/false,
        isMonacoLocal: true/false
    },
    timeouts: {
        init: 15000 // Initialization timeout in ms
    }
};
```

## 3. Deployment & Offline Support

To enable offline support, you must download the dependencies to `assets/js/lib/`.

### Automated Setup
Run the included downloader script:
```bash
php modules/download_deps.php
```
This script fetches:
*   Pyodide v0.23.4 (Core, ASM, WASM, Stdlib)
*   Monaco Editor v0.34.1 (Loader, Editor Core, Python Language Support, Workers, Fonts)

### Directory Structure
```
assets/js/lib/
├── pyodide/
│   ├── pyodide.js
│   ├── pyodide.asm.wasm
│   └── ...
└── monaco-editor/
    └── min/
        └── vs/
            ├── loader.js
            ├── editor/
            └── ...
```

## 4. Troubleshooting

### Common Errors

**1. "Pyodide loading failed"**
*   **Cause**: Network error or missing files.
*   **Fix**: Run `php modules/download_deps.php` to ensure local files are complete. Check browser console for 404 errors.

**2. "Monaco load error" or "require is not defined"**
*   **Cause**: `loader.js` failed to load.
*   **Fix**: Ensure Nginx is configured to serve static assets correctly (MIME types).

**3. "IDE loading timed out"**
*   **Cause**: Network too slow or WASM file blocked.
*   **Fix**: Check Nginx configuration for `application/wasm` MIME type support.

### Nginx Configuration
Ensure your `nginx.conf` includes:
```nginx
types {
    application/wasm wasm;
    ...
}
```

## 5. Development
The core logic is in `includes/ai_modules/scripts.js`.
*   **`IdeManager` Class**: Handles the lifecycle.
*   **`init()`**: Entry point.
*   **`run()`**: Executes Python code.
